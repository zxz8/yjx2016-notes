# 六、相对路径

我们希望把 DLL 和这个程序放到一起，那么 DLL 路径就是程序所在路径加上 DLL 的名称。

将`DllFullPath`的定义注释掉，换成`DllName`：

```cpp
#define DllName "mfc_dll.dll"
```

然后修改`InjectDll`的参数：

```
bool InjectDll(const char *dllFullPath)
```

所有`DllFullPath`都改成`dllFullPath`。

然后试一试`GetCurrentDirectory`函数：

```cpp
int main()
{
    // 用于存放目录
    char dirName[256] = "";
    GetCurrentDirectory(sizeof(dirName), dirName);
    printf("%s\n", dirName);

    // 停住
    getchar();
    
    return 0;
}
```

这是运行结果：

![](https://wx3.sinaimg.cn/large/841aea59ly1foewzj4ny2j20fj02d749.jpg)

我们发现，这个程序是在项目目录的`debug`目录中（见窗口标题），但是取到了另一个目录。这是因为我们用调试模式启动程序，正常启动就好了。

现在我们拼接 DLL 全路径：

```cpp
// 保存 DLL 全路径
char dllFullPath[256] = "";

strcpy_s(dllFullPath, sizeof(dllFullPath), dirName);

// 我们需要补上斜杠
strcat_s(dllFullPath, sizeof(dllFullPath), "\\");

strcat_s(dllFullPath, sizeof(dllFullPath), DllName);
```

之后我们调用`InjectDll`：

```cpp
if(!InjectDll(dllFullPath))
    // ...
```

我们还需要清理项目目录，编写一个`bat`文件：

```bat
REM clear.bat
del *.sdf *.log *.user *.filters *.ipch *.aps /s
del *.exe *.dll /s
del *.suo /s /a h
del *.ilk *.pdb *.exp *.lib *.tlog *.manifest *.res *.lastbuildstate /s
del *.obj *.pch /s
pause
```

## 七、读取人物属性

打开第四节的 MFC 项目，添加一个按钮，把标题（`Caption`属性）改为“测试”。

![](https://wx4.sinaimg.cn/large/841aea59ly1foexqx1sugj20gm0b9q30.jpg)

然后双击这个按钮，程序会自动创建回调：

```cpp
void CMainDialogWnd::OnBnClickedButtonTest()
{
    // TODO:
}
```

我们在里面写一些东西，比如说调试信息：

```cpp
TRACE("GameDebug:我的调试信息\r\n");
```

`TRACE`函数的输出使用工具才能看到。我们打开`DebugView`，点击“编辑->Filter/Highlight”：

![](https://wx1.sinaimg.cn/large/841aea59ly1foexr5hootj20m00dz75p.jpg)

在弹出的窗口中，我们在`Include`后面的编辑框中输出`GameDebug*`：

![](https://wx3.sinaimg.cn/large/841aea59ly1foexrlrcpcj20eg07174j.jpg)

这样，我们就看不到不是我们发出的调试信息了。之后运行我们运行我们的程序，点击“测试”，就能看到调试信息：

![](https://wx2.sinaimg.cn/large/841aea59ly1foexs039f0j20jm0a1gma.jpg)

好，下面读取人物属性。在全局定义：

```cpp
#define BaseRole 0x2f860f0
```

然后在回调中添加：

```cpp
TRACE("GameDebug: 人物名=%s\r\n", BaseRole);
TRACE("GameDebug: 人物等级=%d\r\n", *(BYTE*)(BaseRole+0x34));
```

运行，点击按钮，我们可以看到属性信息：

![](https://wx1.sinaimg.cn/large/841aea59ly1foexs7knavj20lx052jrr.jpg)
